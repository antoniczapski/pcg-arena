# PCG Arena - Pairwise Rating Platform for Mario PCG Generators

## What this repository is

**PCG Arena** is a **fully operational web platform** for evaluating Mario level generators through human preference data. Players play two levels side-by-side in their browser, vote for their favorite, and the platform maintains a **Glicko-2 leaderboard** of generators based on pairwise comparisons.

**Live at:** [https://pcg-arena.com](https://pcg-arena.com)

### Key Features

- Browser-playable Mario - No download required, runs in any modern browser
- Glicko-2 Rating System - Uncertainty-aware ratings with deviation tracking
- AGIS Matchmaking - Adaptive algorithm for efficient rating convergence  
- Builder Profile - Researchers can submit their own generators
- Research Analytics - Telemetry, trajectories, heatmaps, and data export
- Authentication - Google OAuth and email/password login
- Admin Dashboard - Comprehensive management tools

This platform is directly inspired by the **Mario AI Championship "Level Generation Track"**, where humans play content generated by different generators and choose what they prefer.

---

## Quick Links

| Resource | Description |
|----------|-------------|
| [Live Platform](https://pcg-arena.com) | Play battles and vote |
| [Leaderboard](https://pcg-arena.com/leaderboard) | Current generator rankings |
| [Builder Profile](https://pcg-arena.com/builder) | Submit your generator |
| [Admin Dashboard](https://pcg-arena.com/admin) | Admin-only analytics |

---

## Implementation Status - All Stages Complete

| Stage | Name | Status | Description |
|-------|------|--------|-------------|
| **0** | Concept Validation | Complete | Local prototype with Java client |
| **1** | Cloud Deployment | Complete | GCP deployment with Docker |
| **2** | Browser Frontend | Complete | React/TypeScript Mario engine |
| **3** | Builder Profile | Complete | Auth + generator submission |
| **4** | Platform Refinement | Complete | Glicko-2, AGIS, admin dashboard |
| **5** | Research Analytics | Complete | Telemetry, trajectories, export |

---

## API Endpoints Summary

### Core Gameplay
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /health | Health check with metrics |
| GET | /v1/leaderboard | Generator rankings (Glicko-2) |
| POST | /v1/battles:next | Get next battle |
| POST | /v1/votes | Submit vote with telemetry |
| POST | /v1/battles:practice | Practice a specific level |

### Authentication (Stage 3)
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /v1/auth/google | Google OAuth login |
| POST | /v1/auth/register | Email/password registration |
| POST | /v1/auth/login | Email/password login |
| POST | /v1/auth/logout | End session |
| POST | /v1/auth/verify-email | Verify email token |
| POST | /v1/auth/forgot-password | Request password reset |
| POST | /v1/auth/reset-password | Reset with token |

### Builder Profile (Stage 3)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /v1/builders/generators | List user's generators |
| POST | /v1/builders/generators/upload | Upload new generator (ZIP) |
| PUT | /v1/builders/generators/{id}/upload | Update generator |
| DELETE | /v1/builders/generators/{id} | Delete generator |

### Statistics (Stage 5)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /v1/stats/platform | Platform-wide metrics |
| GET | /v1/stats/generators/{id} | Generator statistics |
| GET | /v1/stats/levels/{id} | Level statistics |
| GET | /v1/stats/levels/{id}/heatmap | Death heatmap data |
| GET | /v1/stats/levels/{id}/trajectories | Player paths |
| GET | /v1/stats/confusion-matrix | Pairwise win rates |

### Admin (Stage 4/5)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /v1/admin/stats | Matchmaking statistics |
| GET | /v1/admin/builders | List all builders |
| DELETE | /v1/admin/builders/{id} | Ban builder |
| GET | /v1/admin/generators | List all generators |
| DELETE | /v1/admin/generators/{id} | Delete generator |
| GET | /v1/admin/export/votes | Export vote data |
| GET | /v1/admin/export/trajectories | Export trajectories |
| GET | /v1/admin/export/level-stats | Export level stats |
| GET | /v1/admin/export/player-profiles | Export player profiles |
| POST | /v1/admin/extract-features | Extract level features |

---

## Database Schema

17 tables across 17 migrations:

| Table | Purpose |
|-------|---------|
| generators | PCG algorithm identities with owner |
| levels | ASCII tilemap levels |
| battles | Comparison instances |
| votes | User outcomes with telemetry |
| ratings | Glicko-2 ratings per generator |
| rating_events | Rating change audit log |
| generator_pair_stats | Pairwise battle counts |
| users | Authenticated users |
| user_sessions | Active sessions |
| email_verifications | Email verification tokens |
| password_resets | Password reset tokens |
| level_stats | Per-level performance metrics |
| level_features | Structural analysis data |
| player_profiles | Anonymous player tracking |
| player_sessions | Session activity |
| play_trajectories | Position and death data |
| schema_migrations | Migration tracking |

---

## Configuration

Key environment variables (see backend/spec.md for complete list):

| Variable | Default | Description |
|----------|---------|-------------|
| ARENA_DB_PATH | /data/arena.sqlite | Database path |
| ARENA_MATCHMAKING_POLICY | agis_v1 | Matchmaking algorithm |
| ARENA_INITIAL_RATING | 1000.0 | Starting Glicko-2 rating |
| ARENA_INITIAL_RD | 350.0 | Initial rating deviation |
| ARENA_AGIS_MIN_GAMES | 30 | Games for convergence |
| ARENA_AGIS_TARGET_BATTLES_PER_PAIR | 10 | Target per pair |
| ARENA_ADMIN_EMAILS | (configured) | Admin email list |
| ARENA_GOOGLE_CLIENT_ID | (required) | Google OAuth client |
| SENDGRID_API_KEY | (required) | Email service |

---

## Quickstart (Local Development)

### Prerequisites
- Docker + Docker Compose
- Node.js 18+ (for frontend development)

### Run Backend
`ash
docker compose up --build
# Backend at http://localhost:8080
`

### Run Frontend (Development)
`ash
cd frontend
npm install
npm run dev
# Frontend at http://localhost:3000
`

### Run Tests
`ash
cd backend
pytest
`

---

## Adding a New Generator

### As a Builder (Web UI)
1. Go to [pcg-arena.com/builder](https://pcg-arena.com/builder)
2. Sign in with Google or email
3. Click "Add Generator"
4. Upload ZIP with 50-200 level files (ASCII tilemap format)
5. Generator appears on leaderboard immediately

### As a Developer (Seed Data)
1. Add entry to db/seed/generators.json
2. Create db/seed/levels/{generator_id}/ directory
3. Add level files (.txt, ASCII tilemap, 10-20 lines up to 250 chars)
4. Restart backend: docker compose up --build

---

## Research Data Export

Admin users can export research data via /admin:

- **Votes Export** - All votes with full telemetry
- **Trajectories Export** - Player movement paths
- **Level Stats Export** - Per-level performance metrics
- **Player Profiles Export** - Anonymous preference patterns

---

## Contributing

See individual spec files for detailed documentation:
- backend/spec.md - Backend API and implementation
- frontend/spec.md - Frontend architecture and components
- db/spec.md - Database schema and migrations

---

## License

Open source. See LICENSE file for details.